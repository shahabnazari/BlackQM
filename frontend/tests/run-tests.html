<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Upload Test Suite - Live Testing</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f7;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #1d1d1f;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #86868b;
            margin-bottom: 30px;
        }
        .test-frame {
            width: 100%;
            height: 80vh;
            border: 1px solid #e5e5e7;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #007aff;
            color: white;
        }
        .btn-primary:hover {
            background: #0056b3;
        }
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        .status {
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        .status-ready {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-running {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status-complete {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Image Upload Test Suite - Live Testing</h1>
        <p class="subtitle">Comprehensive testing for image upload functionality in the rich text editor</p>
        
        <div class="status status-ready" id="status">
            Ready to run tests. Click "Start Tests" to begin.
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="startTests()">Start Tests</button>
            <button class="btn btn-secondary" onclick="openTestPage()">Open Test Page</button>
            <button class="btn btn-secondary" onclick="clearConsole()">Clear Console</button>
        </div>
        
        <iframe id="testFrame" class="test-frame" src="http://localhost:3000/studies/create"></iframe>
        
        <div class="console-output" id="consoleOutput">Ready to run tests...</div>
    </div>

    <script>
        let testResults = null;
        let isRunning = false;
        
        function updateStatus(message, type = 'ready') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status status-${type}`;
        }
        
        function logToConsole(message) {
            const output = document.getElementById('consoleOutput');
            output.textContent += message + '\n';
            output.scrollTop = output.scrollHeight;
        }
        
        function clearConsole() {
            document.getElementById('consoleOutput').textContent = 'Console cleared...\n';
        }
        
        function openTestPage() {
            window.open('http://localhost:3000/studies/create', '_blank');
        }
        
        async function startTests() {
            if (isRunning) {
                logToConsole('Tests are already running...');
                return;
            }
            
            isRunning = true;
            updateStatus('Running tests...', 'running');
            logToConsole('üöÄ Starting Image Upload Test Suite...');
            
            try {
                // Get the iframe content
                const iframe = document.getElementById('testFrame');
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                // Wait for iframe to load
                await new Promise(resolve => {
                    if (iframeDoc.readyState === 'complete') {
                        resolve();
                    } else {
                        iframe.onload = resolve;
                    }
                });
                
                // Inject test script into iframe
                const testScript = iframeDoc.createElement('script');
                testScript.textContent = `
                    // Test Configuration
                    const CONFIG = {
                        baseUrl: 'http://localhost:3000',
                        timeout: 5000,
                        testImages: {
                            small: { width: 100, height: 100 },
                            medium: { width: 500, height: 300 },
                            large: { width: 1920, height: 1080 },
                            square: { width: 400, height: 400 },
                            portrait: { width: 300, height: 600 },
                            landscape: { width: 800, height: 400 }
                        }
                    };
                    
                    // Test Results
                    let testResults = {
                        passed: 0,
                        failed: 0,
                        total: 0,
                        details: [],
                        startTime: null,
                        endTime: null
                    };
                    
                    // Utility Functions
                    function logTest(testName, status, details = '') {
                        testResults.total++;
                        const timestamp = new Date().toISOString();
                        
                        if (status === 'PASS') {
                            testResults.passed++;
                            console.log(\`‚úÖ \${testName}: PASSED\`);
                        } else {
                            testResults.failed++;
                            console.log(\`‚ùå \${testName}: FAILED - \${details}\`);
                        }
                        
                        testResults.details.push({ 
                            testName, 
                            status, 
                            details, 
                            timestamp 
                        });
                    }
                    
                    function createTestImage(width, height, format = 'png') {
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        
                        // Create a gradient background
                        const gradient = ctx.createLinearGradient(0, 0, width, height);
                        gradient.addColorStop(0, '#ff6b6b');
                        gradient.addColorStop(0.5, '#4ecdc4');
                        gradient.addColorStop(1, '#45b7d1');
                        
                        ctx.fillStyle = gradient;
                        ctx.fillRect(0, 0, width, height);
                        
                        // Add some text
                        ctx.fillStyle = 'white';
                        ctx.font = 'bold 24px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(\`\${width}√ó\${height}\`, width/2, height/2);
                        
                        return canvas.toDataURL(\`image/\${format}\`);
                    }
                    
                    function simulateFileUpload(fileInput, file) {
                        return new Promise((resolve) => {
                            const dataTransfer = new DataTransfer();
                            dataTransfer.items.add(file);
                            fileInput.files = dataTransfer.files;
                            
                            const changeEvent = new Event('change', { bubbles: true });
                            fileInput.dispatchEvent(changeEvent);
                            
                            setTimeout(resolve, 1000);
                        });
                    }
                    
                    // Test Functions
                    async function testBasicImageUpload() {
                        console.log('\\nüß™ TESTING: Basic Image Upload Functionality');
                        
                        try {
                            // Test 1: Find image upload button
                            const uploadButton = document.querySelector('[data-testid="image-upload-button"]') || 
                                               document.querySelector('button[title*="image" i]') ||
                                               document.querySelector('button[aria-label*="image" i]') ||
                                               document.querySelector('button[class*="image"]') ||
                                               document.querySelector('button[class*="upload"]');
                            
                            if (uploadButton) {
                                logTest('Image Upload Button Found', 'PASS', \`Found: \${uploadButton.tagName} with classes: \${uploadButton.className}\`);
                            } else {
                                logTest('Image Upload Button Found', 'FAIL', 'No image upload button found');
                                return false;
                            }
                            
                            // Test 2: Click upload button
                            try {
                                uploadButton.click();
                                await new Promise(resolve => setTimeout(resolve, 500));
                                logTest('Image Upload Button Clickable', 'PASS');
                            } catch (error) {
                                logTest('Image Upload Button Clickable', 'FAIL', error.message);
                            }
                            
                            // Test 3: Find file input
                            const fileInput = document.querySelector('input[type="file"][accept*="image"]') ||
                                             document.querySelector('input[type="file"]');
                            
                            if (fileInput) {
                                logTest('File Input Found', 'PASS', \`Accept: \${fileInput.accept}\`);
                            } else {
                                logTest('File Input Found', 'FAIL', 'No file input found');
                                return false;
                            }
                            
                            return true;
                            
                        } catch (error) {
                            logTest('Basic Image Upload', 'FAIL', error.message);
                            return false;
                        }
                    }
                    
                    async function testImageUploadSizes() {
                        console.log('\\nüß™ TESTING: Image Upload Size Handling');
                        
                        try {
                            const fileInput = document.querySelector('input[type="file"][accept*="image"]') ||
                                             document.querySelector('input[type="file"]');
                            
                            if (!fileInput) {
                                logTest('Image Size Testing', 'FAIL', 'File input not found');
                                return false;
                            }
                            
                            let successCount = 0;
                            const totalTests = Object.keys(CONFIG.testImages).length;
                            
                            for (const [sizeName, sizeInfo] of Object.entries(CONFIG.testImages)) {
                                try {
                                    const testImage = createTestImage(sizeInfo.width, sizeInfo.height);
                                    const blob = await fetch(testImage).then(r => r.blob());
                                    const file = new File([blob], \`test-\${sizeName}.png\`, { type: 'image/png' });
                                    
                                    await simulateFileUpload(fileInput, file);
                                    
                                    // Check if image was inserted
                                    const insertedImage = document.querySelector('img[src*="data:image"]') ||
                                                        document.querySelector('.simple-image img') ||
                                                        document.querySelector('img[src*="blob:"]');
                                    
                                    if (insertedImage) {
                                        logTest(\`Image Upload - \${sizeName} (\${sizeInfo.width}√ó\${sizeInfo.height})\`, 'PASS');
                                        successCount++;
                                    } else {
                                        logTest(\`Image Upload - \${sizeName} (\${sizeInfo.width}√ó\${sizeInfo.height})\`, 'FAIL', 'Image not inserted');
                                    }
                                    
                                } catch (error) {
                                    logTest(\`Image Upload - \${sizeName}\`, 'FAIL', error.message);
                                }
                            }
                            
                            logTest('Image Size Testing Overall', successCount === totalTests ? 'PASS' : 'FAIL', 
                                   \`\${successCount}/\${totalTests} tests passed\`);
                            
                            return successCount > 0;
                            
                        } catch (error) {
                            logTest('Image Size Testing', 'FAIL', error.message);
                            return false;
                        }
                    }
                    
                    async function testImageResizeFunctionality() {
                        console.log('\\nüß™ TESTING: Image Resize Functionality');
                        
                        try {
                            // Find images
                            const images = document.querySelectorAll('img[src*="data:image"], .simple-image img, img[src*="blob:"]');
                            
                            if (images.length === 0) {
                                logTest('Image Resize - Images Found', 'FAIL', 'No images found for resize testing');
                                return false;
                            }
                            
                            logTest('Image Resize - Images Found', 'PASS', \`Found \${images.length} image(s)\`);
                            
                            let resizeTestsPassed = 0;
                            let totalResizeTests = 0;
                            
                            for (let i = 0; i < images.length; i++) {
                                const image = images[i];
                                const imageContainer = image.closest('.simple-image-wrapper') || 
                                                     image.closest('.simple-image') ||
                                                     image.parentElement;
                                
                                if (imageContainer) {
                                    totalResizeTests++;
                                    
                                    // Hover over image to show controls
                                    const mouseEnterEvent = new MouseEvent('mouseenter', { bubbles: true });
                                    imageContainer.dispatchEvent(mouseEnterEvent);
                                    
                                    await new Promise(resolve => setTimeout(resolve, 300));
                                    
                                    // Test resize handles
                                    const resizeHandle = imageContainer.querySelector('.react-resizable-handle') ||
                                                       imageContainer.querySelector('[style*="cursor: nwse-resize"]') ||
                                                       imageContainer.querySelector('[class*="resize"]') ||
                                                       imageContainer.querySelector('.react-rnd');
                                    
                                    if (resizeHandle) {
                                        logTest(\`Image Resize - Handle \${i + 1}\`, 'PASS');
                                        resizeTestsPassed++;
                                    } else {
                                        logTest(\`Image Resize - Handle \${i + 1}\`, 'FAIL', 'Resize handle not found');
                                    }
                                    
                                    // Test drag handle
                                    const dragHandle = imageContainer.querySelector('.drag-handle') ||
                                                      imageContainer.querySelector('[title*="move" i]') ||
                                                      imageContainer.querySelector('[aria-label*="move" i]');
                                    
                                    if (dragHandle) {
                                        logTest(\`Image Drag - Handle \${i + 1}\`, 'PASS');
                                        resizeTestsPassed++;
                                    } else {
                                        logTest(\`Image Drag - Handle \${i + 1}\`, 'FAIL', 'Drag handle not found');
                                    }
                                    
                                    // Test action buttons
                                    const rotateButton = imageContainer.querySelector('button[title*="rotate" i]') ||
                                                       imageContainer.querySelector('button[aria-label*="rotate" i]') ||
                                                       imageContainer.querySelector('button[class*="rotate"]');
                                    
                                    if (rotateButton) {
                                        logTest(\`Image Rotate - Button \${i + 1}\`, 'PASS');
                                        resizeTestsPassed++;
                                    } else {
                                        logTest(\`Image Rotate - Button \${i + 1}\`, 'FAIL', 'Rotate button not found');
                                    }
                                    
                                    const removeButton = imageContainer.querySelector('button[title*="remove" i]') ||
                                                       imageContainer.querySelector('button[aria-label*="remove" i]') ||
                                                       imageContainer.querySelector('button[title*="delete" i]') ||
                                                       imageContainer.querySelector('button[class*="remove"]');
                                    
                                    if (removeButton) {
                                        logTest(\`Image Remove - Button \${i + 1}\`, 'PASS');
                                        resizeTestsPassed++;
                                    } else {
                                        logTest(\`Image Remove - Button \${i + 1}\`, 'FAIL', 'Remove button not found');
                                    }
                                }
                            }
                            
                            logTest('Image Resize Functionality Overall', 
                                   resizeTestsPassed > 0 ? 'PASS' : 'FAIL', 
                                   \`\${resizeTestsPassed} resize features working\`);
                            
                            return resizeTestsPassed > 0;
                            
                        } catch (error) {
                            logTest('Image Resize Functionality', 'FAIL', error.message);
                            return false;
                        }
                    }
                    
                    async function testImageTextIntegration() {
                        console.log('\\nüß™ TESTING: Image Text Integration');
                        
                        try {
                            // Find rich text editor
                            const editor = document.querySelector('.ProseMirror') || 
                                          document.querySelector('[contenteditable="true"]') ||
                                          document.querySelector('.tiptap') ||
                                          document.querySelector('.rich-text-editor');
                            
                            if (!editor) {
                                logTest('Image Text Integration - Editor Found', 'FAIL', 'Rich text editor not found');
                                return false;
                            }
                            
                            logTest('Image Text Integration - Editor Found', 'PASS');
                            
                            // Test images in editor
                            const images = editor.querySelectorAll('img');
                            if (images.length > 0) {
                                logTest('Image Text Integration - Images in Editor', 'PASS', \`Found \${images.length} image(s) in editor\`);
                                
                                // Test inline display
                                const firstImage = images[0];
                                const computedStyle = window.getComputedStyle(firstImage);
                                
                                if (computedStyle.display === 'inline' || computedStyle.display === 'inline-block') {
                                    logTest('Image Text Integration - Inline Display', 'PASS');
                                } else {
                                    logTest('Image Text Integration - Inline Display', 'FAIL', \`Display: \${computedStyle.display}\`);
                                }
                            } else {
                                logTest('Image Text Integration - Images in Editor', 'FAIL', 'No images found in editor');
                            }
                            
                            // Test text flow
                            const textContent = editor.textContent || editor.innerText;
                            if (textContent && textContent.length > 0) {
                                logTest('Image Text Integration - Text Flow', 'PASS', 'Text content present');
                            } else {
                                logTest('Image Text Integration - Text Flow', 'FAIL', 'No text content found');
                            }
                            
                            return true;
                            
                        } catch (error) {
                            logTest('Image Text Integration', 'FAIL', error.message);
                            return false;
                        }
                    }
                    
                    // Main Test Runner
                    async function runImageUploadTestSuite() {
                        console.log('üöÄ STARTING COMPREHENSIVE IMAGE UPLOAD TEST SUITE');
                        console.log('=' .repeat(60));
                        
                        testResults.startTime = performance.now();
                        testResults.passed = 0;
                        testResults.failed = 0;
                        testResults.total = 0;
                        testResults.details = [];
                        
                        try {
                            // Run all test suites
                            await testBasicImageUpload();
                            await testImageUploadSizes();
                            await testImageResizeFunctionality();
                            await testImageTextIntegration();
                            
                        } catch (error) {
                            console.error('‚ùå Test suite failed:', error);
                            logTest('Test Suite Execution', 'FAIL', error.message);
                        }
                        
                        testResults.endTime = performance.now();
                        const totalTime = testResults.endTime - testResults.startTime;
                        
                        // Generate test report
                        console.log('\\n' + '=' .repeat(60));
                        console.log('üìä TEST SUITE RESULTS');
                        console.log('=' .repeat(60));
                        console.log(\`Total Tests: \${testResults.total}\`);
                        console.log(\`Passed: \${testResults.passed} ‚úÖ\`);
                        console.log(\`Failed: \${testResults.failed} ‚ùå\`);
                        console.log(\`Success Rate: \${((testResults.passed / testResults.total) * 100).toFixed(2)}%\`);
                        console.log(\`Total Time: \${totalTime.toFixed(2)}ms\`);
                        
                        // Detailed results
                        console.log('\\nüìã DETAILED RESULTS:');
                        testResults.details.forEach((test, index) => {
                            const status = test.status === 'PASS' ? '‚úÖ' : '‚ùå';
                            console.log(\`\${index + 1}. \${status} \${test.testName}\`);
                            if (test.details) {
                                console.log(\`   Details: \${test.details}\`);
                            }
                        });
                        
                        console.log('\\nüéâ Test suite completed!');
                        
                        // Send results to parent window
                        window.parent.postMessage({
                            type: 'testResults',
                            results: testResults
                        }, '*');
                        
                        return testResults;
                    }
                    
                    // Start tests
                    runImageUploadTestSuite();
                `;
                
                iframeDoc.head.appendChild(testScript);
                
                // Listen for test results
                window.addEventListener('message', (event) => {
                    if (event.data.type === 'testResults') {
                        testResults = event.data.results;
                        updateStatus('Tests completed!', 'complete');
                        logToConsole(`\\nüìä Test Results: ${testResults.passed}/${testResults.total} passed (${((testResults.passed / testResults.total) * 100).toFixed(1)}%)`);
                        isRunning = false;
                    }
                });
                
            } catch (error) {
                logToConsole('‚ùå Error running tests: ' + error.message);
                updateStatus('Test failed', 'ready');
                isRunning = false;
            }
        }
        
        // Initialize
        logToConsole('Image Upload Test Suite loaded. Click "Start Tests" to begin testing.');
    </script>
</body>
</html>
