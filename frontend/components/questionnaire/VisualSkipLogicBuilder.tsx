'use client';

import React, { useCallback, useMemo, useState } from 'react';

import { cn } from '@/lib/utils';
import {  Node,  Edge,  Controls,  Background,  useEdgesState,  addEdge,  Connection,  MarkerType,  Handle,  Position,  NodeProps
} from 'reactflow'
import { GitBranch, Eye, EyeOff, Filter, Info, Layers, AlertCircle } from 'lucide-react';
import { Question, QuestionType, SkipLogic } from '@/lib/types/questionnaire';

import 'reactflow/dist/style.css';

interface VisualSkipLogicBuilderProps {
  questions: Question[];
  onUpdateLogic: (questionId: string, logic: SkipLogic) => void;
  selectedQuestionId?: string;
}
// Custom node component for questions
const QuestionNode: React.FC<NodeProps> = ({ data, selected }) => {  const getQuestionIcon = (type: QuestionType) => {  switch (type) {  case QuestionType.MULTIPLE_CHOICE_SINGLE:  case QuestionType.MULTIPLE_CHOICE_MULTI: return 'üìù'  case QuestionType.LIKERT_SCALE:  case QuestionType.RATING_SCALE:  return '‚≠ê';  case QuestionType.TEXT_SHORT:  case QuestionType.TEXT_LONG:  return 'üí¨';  case QuestionType.NET_PROMOTER_SCORE:  return 'üìä';  default:  return '‚ùì'}  }  return (  <div  className={cn(  'px-4 py-3 rounded-lg border-2 bg-white dark:bg-gray-800 min-w-[200px] transition-all',  selected  ? 'border-blue-500 shadow-lg shadow-blue-500/20'  : 'border-gray-300 dark:border-gray-600 hover:border-gray-400'  )}  >  <Handle  type="target"  position={Position.Top}  className="w-3 h-3 bg-gray-400 border-2 border-white dark:border-gray-800"  />  <div className="flex items-start gap-2">  <span className="text-lg">{getQuestionIcon(data.type)}</span>  <div className="flex-1">  <div className="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">  Q{data.order + 1}  </div>  <div className="text-sm font-medium text-gray-900 dark:text-gray-100 line-clamp-2">  {data.text}  </div>  {data.required && (  <div className="flex items-center gap-1 mt-1">  <AlertCircle className="w-3 h-3 text-red-500" />  <span className="text-xs text-red-500">Required</span>  </div>  )}  </div>  </div>  <Handle  type="source"  position={Position.Bottom}  className="w-3 h-3 bg-blue-500 border-2 border-white dark:border-gray-800"  />  </div>  );
}
// Custom node for logic conditions
const ConditionNode: React.FC<NodeProps> = ({ data }) => {  return (  <div className="px-3 py-2 rounded-md bg-yellow-100 dark:bg-yellow-900/30 border border-yellow-300 dark:border-yellow-700 min-w-[150px]">  <Handle type="target" position={Position.Top} className="w-2 h-2 bg-yellow-500" />  <div className="flex items-center gap-2">  <Filter className="w-3 h-3 text-yellow-600 dark:text-yellow-400" />  <div className="text-xs font-medium text-yellow-700 dark:text-yellow-300">  {data.operator} {data.value}  </div>  </div>  <Handle type="source" position={Position.Bottom} className="w-2 h-2 bg-yellow-500" />  </div>  );
}
// Custom node for section/group
const SectionNode: React.FC<NodeProps> = ({ data, selected }) => {  return (  <div  className={cn(  'px-4 py-3 rounded-lg border-2 bg-gradient-to-br from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 min-w-[250px]',  selected ? 'border-purple-500 shadow-lg' : 'border-purple-300 dark:border-purple-700'  )}  >  <Handle type="target" position={Position.Top} className="w-3 h-3 bg-purple-400" />  <div className="flex items-center gap-2">  <Layers className="w-4 h-4 text-purple-600 dark:text-purple-400" />  <div>  <div className="text-sm font-semibold text-purple-900 dark:text-purple-100">  {data.title}  </div>  <div className="text-xs text-purple-600 dark:text-purple-400">  {data.questionCount} questions  </div>  </div>  </div>  <Handle type="source" position={Position.Bottom} className="w-3 h-3 bg-purple-500" />  </div>  )}
const nodeTypes = {  question: QuestionNode,  condition: ConditionNode,  section: SectionNode}
export const VisualSkipLogicBuilder: React.FC<VisualSkipLogicBuilderProps> = ({  questions,  onUpdateLogic}) => {;  const [showConditions, setShowConditions] = useState(true);  const [showSections, setShowSections] = useState(true);  const [setEditingConnection] = useState<string | null>(null);  // Convert questions to flow nodes  const initialNodes = useMemo(() => {;  const nodes: Node[] = [];  let yPosition = 0;  questions.forEach((q: any, index: any) => {  // Add question node  nodes.push({  id: q.id,  type: 'question',  position: { x: 250, y: yPosition },  data: {  ...(q as any),  order: index  })  // Add condition nodes if skip logic exists  if (q.skipLogic && Array.isArray(q.skipLogic) && q.skipLogic.length > 0 && showConditions) {  q.skipLogic.forEach((logic: any) => {  logic.conditions.forEach((condition, cIndex: any) => {  nodes.push({  id: `${q.id}-condition-${cIndex}`,  type: 'condition',  position: { x: 500, y: yPosition + 20 },  data: {  operator: condition.operator,  value: condition.value,  targetQuestionId: logic.targetQuestionId  })  })  })  }  yPosition += 120  })  return nodes}, [questions, showConditions])  // Create edges based on skip logic  const initialEdges = useMemo(() => {;  const edges: Edge[] = [];  // Sequential flow edges  for (let i = 0; i < questions.length - 1; i++) {  edges.push({  id: `${questions[i].id}-${questions[i + 1].id}`,  source: questions[i].id,  target: questions[i + 1].id,  type: 'smoothstep',  animated: false,  style: { stroke: '#94a3b8', strokeWidth: 2 })  }  // Skip logic edges  questions.forEach((q: any) => {  if (q.skipLogic && Array.isArray(q.skipLogic) && q.skipLogic.length > 0) {  q.skipLogic.forEach((logic: any, logicIndex: any) => {  if (  const label =;  logic.conditions && logic.conditions.length > 0  ? `${logic.conditions[0].operator) { $}$3logic.conditions[0].value}` : logic.action  edges.push({  id: `${q.id}-skip-${logicIndex}`,  source: q.id,  target: logic.targetQuestionId,  type: 'smoothstep',  animated: true,  style: { stroke: '#f59e0b', strokeWidth: 2, strokeDasharray: '5 5' },  markerEnd: {  type: MarkerType.ArrowClosed,  color: '#f59e0b'  },  label,  labelStyle: { fill: '#f59e0b', fontWeight: 600, fontSize: 11 },  labelBgStyle: { fill: 'white', fillOpacity: 0.9 })  })  })  return edges}, [questions]);  //  const [nodes, setNodes, onNodesChange] = useNodesState(initialNodes);  const [edges, setEdges, onEdgesChange] = useEdgesState(initialEdges);  const onConnect = useCallback(  (params: Connection) => {  if (;  // Create skip logic when connecting nodes;  const sourceQuestion = questions.find((q: any) => q.id === params.source);  const targetQuestion = questions.find((q: any) => q.id === params.target);  if (sourceQuestion && targetQuestion) {  const newLogic: SkipLogic = {  action: 'skip_to',  targetQuestionId: targetQuestion.id,  conditions: [  {  questionId: sourceQuestion.id,  operator: 'equals',  value: ''  ) {  ]  }  onUpdateLogic(sourceQuestion.id, newLogic)  }  }  setEdges((eds: any) =>  addEdge(  }$3  ...(params as any),  animated: true,  style: { stroke: '#f59e0b', strokeWidth: 2, strokeDasharray: '5 5' }  },  eds  )  )  },  [questions, onUpdateLogic, setEdges]  )  return (  <div className="h-full flex flex-col">  {/* Header Controls */}  <div className="p-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">  <div className="flex items-center justify-between mb-3">  <div className="flex items-center gap-2">  <GitBranch className="w-5 h-5 text-blue-500" />  <h3 className="text-sm font-semibold text-gray-900 dark:text-gray-100">  Visual Skip Logic Builder  </h3>  </div>  <div className="flex items-center gap-2">  <button  onClick={() => setShowConditions(!showConditions)}  className={cn(  'flex items-center gap-1 px-2 py-1 text-xs rounded-md transition-colors',  showConditions  ? 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400'  : 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400'  )}  >  {showConditions ? <Eye className="w-3 h-3" /> : <EyeOff className="w-3 h-3" />}  Conditions  </button>  <button  onClick={() => setShowSections(!showSections)}  className={cn(  'flex items-center gap-1 px-2 py-1 text-xs rounded-md transition-colors',  showSections  ? 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400'  : 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400'  )}  >  {showSections ? <Eye className="w-3 h-3" /> : <EyeOff className="w-3 h-3" />}  Sections  </button>  </div>  </div>  {/* Legend */}  <div className="flex items-center gap-4 text-xs">  <div className="flex items-center gap-1">  <div className="w-3 h-0.5 bg-gray-400"></div>  <span className="text-gray-600 dark:text-gray-400">Sequential Flow</span>  </div>  <div className="flex items-center gap-1">  <div  className="w-3 h-0.5 bg-yellow-500"  style={{ borderStyle: 'dashed', borderWidth: 1, borderColor: '#f59e0b' }}  ></div>  <span className="text-gray-600 dark:text-gray-400">Skip Logic</span>  </div>  <div className="flex items-center gap-1">  <div className="w-2 h-2 rounded-full bg-blue-500"></div>  <span className="text-gray-600 dark:text-gray-400">Source</span>  </div>  <div className="flex items-center gap-1">  <div className="w-2 h-2 rounded-full bg-gray-400"></div>  <span className="text-gray-600 dark:text-gray-400">Target</span>  </div>  </div>  </div>  {/* Flow Diagram */}  <div className="flex-1 bg-gray-50 dark:bg-gray-900">  <ReactFlow  nodes={nodes}  edges={edges}  onNodesChange={onNodesChange}  onEdgesChange={onEdgesChange}  onConnect={onConnect}  nodeTypes={nodeTypes}  fitView  attributionPosition="bottom-left"  >  <Background gap={12} size={1} color="#94a3b8" />  <Controls showZoom={true} showFitView={true} showInteractive={false} />  </ReactFlow>  </div>  {/* Info Panel */}  <div className="p-3 border-t border-gray-200 dark:border-gray-700 bg-blue-50 dark:bg-blue-900/20">  <div className="flex items-start gap-2">  <Info className="w-4 h-4 text-blue-500 mt-0.5" />  <div className="text-xs text-blue-700 dark:text-blue-300">  <strong>Tip:</strong> Drag from the blue dot (source) to gray dot (target) to create  skip logic. Click on connections to edit conditions. Drag nodes to reorganize the flow.  </div>  </div>  </div>  </div>  )
}