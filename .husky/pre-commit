#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running VQMethod Repository Standards Check..."

# Check for forbidden files in root directory
echo "üìÅ Checking root directory for misplaced files..."

# List of forbidden config files that should NOT be in root
FORBIDDEN_IN_ROOT=(
  "tsconfig.json"
  "tailwind.config.js"
  "next.config.js"
  "vitest.config.ts"
  "playwright.config.ts"
  "nest-cli.json"
  "ormconfig.js"
)

# Check each forbidden file
VIOLATIONS=0
for file in "${FORBIDDEN_IN_ROOT[@]}"; do
  if [ -f "./$file" ]; then
    echo "‚ùå ERROR: $file found in root directory!"
    echo "   This file should be in the appropriate workspace directory:"
    if [[ "$file" == "nest-cli.json" ]] || [[ "$file" == "ormconfig.js" ]]; then
      echo "   Move to: backend/$file"
    else
      echo "   Move to: frontend/$file"
    fi
    VIOLATIONS=$((VIOLATIONS + 1))
  fi
done

# Check for .next directory in root
if [ -d "./.next" ]; then
  echo "‚ùå ERROR: .next/ build directory found in root!"
  echo "   This directory should be in: frontend/.next/"
  VIOLATIONS=$((VIOLATIONS + 1))
fi

# Check for dist directory in root
if [ -d "./dist" ]; then
  echo "‚ùå ERROR: dist/ build directory found in root!"
  echo "   This directory should be in: backend/dist/"
  VIOLATIONS=$((VIOLATIONS + 1))
fi

# Check for prisma directory in root
if [ -d "./prisma" ]; then
  echo "‚ùå ERROR: prisma/ directory found in root!"
  echo "   This directory should be in: backend/prisma/"
  VIOLATIONS=$((VIOLATIONS + 1))
fi

# Check that required workspace files exist
echo "üìÇ Checking workspace structure..."

REQUIRED_FILES=(
  "frontend/package.json"
  "frontend/next.config.js"
  "frontend/tsconfig.json"
  "backend/package.json"
  "backend/nest-cli.json"
  "backend/tsconfig.json"
)

for file in "${REQUIRED_FILES[@]}"; do
  if [ ! -f "./$file" ]; then
    echo "‚ö†Ô∏è  WARNING: Required file missing: $file"
  fi
done

# Check package.json namespaces
echo "üì¶ Checking package.json namespaces..."

if [ -f "./frontend/package.json" ]; then
  if ! grep -q '"name": "@vqmethod/frontend"' ./frontend/package.json; then
    echo "‚ö†Ô∏è  WARNING: frontend/package.json should have name: @vqmethod/frontend"
  fi
fi

if [ -f "./backend/package.json" ]; then
  if ! grep -q '"name": "@vqmethod/backend"' ./backend/package.json; then
    echo "‚ö†Ô∏è  WARNING: backend/package.json should have name: @vqmethod/backend"
  fi
fi

# Run validation script if exists
if [ -f "./scripts/validate-structure.js" ]; then
  echo "üîß Running structure validation script..."
  node ./scripts/validate-structure.js
  if [ $? -ne 0 ]; then
    VIOLATIONS=$((VIOLATIONS + 1))
  fi
fi

# Check for violations
if [ $VIOLATIONS -gt 0 ]; then
  echo ""
  echo "‚ùå COMMIT BLOCKED: $VIOLATIONS repository standard violations found!"
  echo ""
  echo "üìö Please read: Lead/REPOSITORY_STANDARDS.md"
  echo "   for complete guidelines on file organization."
  echo ""
  echo "üîß Quick fix:"
  echo "   1. Move all frontend configs to frontend/ directory"
  echo "   2. Move all backend configs to backend/ directory"
  echo "   3. Keep root directory clean (only workspace files)"
  echo ""
  exit 1
fi

echo "‚úÖ Repository structure check passed!"

# Run other pre-commit checks
echo ""
echo "üß™ Running tests and type checks..."

# Type check frontend
if [ -d "./frontend" ] && [ -f "./frontend/package.json" ]; then
  echo "üìù Type checking frontend..."
  cd frontend
  npm run typecheck 2>/dev/null || echo "‚ö†Ô∏è  Frontend type check skipped (optional)"
  cd ..
fi

# Run tests on changed files
echo "üß™ Running tests on changed files..."
npx vitest related --run $(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' | tr '\n' ' ') 2>/dev/null || echo "‚ö†Ô∏è  Test run skipped (optional)"

echo ""
echo "‚úÖ All pre-commit checks passed!"
echo ""