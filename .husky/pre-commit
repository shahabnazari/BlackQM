echo "üîç Running VQMethod Repository Standards Check..."

# Check for forbidden files in root directory
echo "üìÅ Checking root directory for misplaced files..."

# List of forbidden config files that should NOT be in root
FORBIDDEN_IN_ROOT=(
  "tsconfig.json"
  "tailwind.config.js"
  "next.config.js"
  "vitest.config.ts"
  "playwright.config.ts"
  "nest-cli.json"
  "ormconfig.js"
)

# Check each forbidden file
VIOLATIONS=0
for file in "${FORBIDDEN_IN_ROOT[@]}"; do
  if [ -f "./$file" ]; then
    echo "‚ùå ERROR: $file found in root directory!"
    echo "   This file should be in the appropriate workspace directory:"
    if [[ "$file" == "nest-cli.json" ]] || [[ "$file" == "ormconfig.js" ]]; then
      echo "   Move to: backend/$file"
    else
      echo "   Move to: frontend/$file"
    fi
    VIOLATIONS=$((VIOLATIONS + 1))
  fi
done

# Check for .next directory in root
if [ -d "./.next" ]; then
  echo "‚ùå ERROR: .next/ build directory found in root!"
  echo "   This directory should be in: frontend/.next/"
  VIOLATIONS=$((VIOLATIONS + 1))
fi

# Check for dist directory in root
if [ -d "./dist" ]; then
  echo "‚ùå ERROR: dist/ build directory found in root!"
  echo "   This directory should be in: backend/dist/"
  VIOLATIONS=$((VIOLATIONS + 1))
fi

# Check for prisma directory in root
if [ -d "./prisma" ]; then
  echo "‚ùå ERROR: prisma/ directory found in root!"
  echo "   This directory should be in: backend/prisma/"
  VIOLATIONS=$((VIOLATIONS + 1))
fi

# Check that required workspace files exist
echo "üìÇ Checking workspace structure..."

REQUIRED_FILES=(
  "frontend/package.json"
  "frontend/next.config.js"
  "frontend/tsconfig.json"
  "backend/package.json"
  "backend/nest-cli.json"
  "backend/tsconfig.json"
)

for file in "${REQUIRED_FILES[@]}"; do
  if [ ! -f "./$file" ]; then
    echo "‚ö†Ô∏è  WARNING: Required file missing: $file"
  fi
done

# Check package.json namespaces
echo "üì¶ Checking package.json namespaces..."

if [ -f "./frontend/package.json" ]; then
  if ! grep -q '"name": "@vqmethod/frontend"' ./frontend/package.json; then
    echo "‚ö†Ô∏è  WARNING: frontend/package.json should have name: @vqmethod/frontend"
  fi
fi

if [ -f "./backend/package.json" ]; then
  if ! grep -q '"name": "@vqmethod/backend"' ./backend/package.json; then
    echo "‚ö†Ô∏è  WARNING: backend/package.json should have name: @vqmethod/backend"
  fi
fi

# Run validation script if exists
if [ -f "./scripts/validate-structure.js" ]; then
  echo "üîß Running structure validation script..."
  node ./scripts/validate-structure.js
  if [ $? -ne 0 ]; then
    VIOLATIONS=$((VIOLATIONS + 1))
  fi
fi

# Run file placement validation
if [ -f "./scripts/validate-file-placement.js" ]; then
  echo "üîç Running Next.js file placement validation..."
  node ./scripts/validate-file-placement.js
  if [ $? -ne 0 ]; then
    echo "‚ùå File placement validation failed!"
    echo "üìö See FILE_PLACEMENT_RULES.md for help"
    exit 1
  fi
fi

# Check for violations
if [ $VIOLATIONS -gt 0 ]; then
  echo ""
  echo "‚ùå COMMIT BLOCKED: $VIOLATIONS repository standard violations found!"
  echo ""
  echo "üìö See FILE_PLACEMENT_RULES.md for complete guidelines"
  echo ""
  echo "üîß Quick fixes available:"
  echo "   ‚Ä¢ Run 'npm run organize' to automatically fix file placement"
  echo "   ‚Ä¢ Run 'npm run organize:check' to see what would be moved"
  echo ""
  echo "üìÅ Manual fix:"
  echo "   1. Move all frontend configs to frontend/ directory"
  echo "   2. Move all backend configs to backend/ directory"
  echo "   3. Keep root directory clean (only workspace files)"
  echo ""
  exit 1
fi

echo "‚úÖ Repository structure check passed!"

# Run other pre-commit checks
echo ""
echo "üß™ Running quality checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Type check frontend
if [ -d "./frontend" ] && [ -f "./frontend/package.json" ]; then
  echo "üìù Type checking frontend..."
  cd frontend
  npm run typecheck
  if [ $? -ne 0 ]; then
    echo -e "${RED}‚ùå Frontend TypeScript errors found!${NC}"
    cd ..
    exit 1
  fi
  echo -e "${GREEN}‚úì Frontend TypeScript check passed${NC}"
  
  # Apple HIG validation  
  echo "üçé Running Apple HIG validation..."
  npm run apple-design:validate
  if [ $? -ne 0 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Apple HIG compliance below 95% - please review${NC}"
    # Don't block for now, just warn
  else
    echo -e "${GREEN}‚úì Apple HIG standards met (95%+)${NC}"
  fi
  
  # Run tests for Apple UI components if changed
  APPLE_UI_CHANGED=$(git diff --cached --name-only | grep -E 'frontend/components/apple-ui/.*\.tsx$' | grep -v test || true)
  if [ -n "$APPLE_UI_CHANGED" ]; then
    echo "üß™ Running Apple UI component tests..."
    npm test -- components/apple-ui --run --coverage.enabled=false 2>/dev/null
    if [ $? -eq 0 ]; then
      echo -e "${GREEN}‚úì Component tests passed${NC}"
    else
      echo -e "${YELLOW}‚ö†Ô∏è  Some tests need attention${NC}"
    fi
  fi
  
  cd ..
fi

# Type check backend
if [ -d "./backend" ] && [ -f "./backend/package.json" ]; then
  echo "üìù Type checking backend..."
  cd backend
  npm run build >/dev/null 2>&1
  if [ $? -ne 0 ]; then
    echo -e "${RED}‚ùå Backend build failed!${NC}"
    cd ..
    exit 1
  fi
  echo -e "${GREEN}‚úì Backend build check passed${NC}"
  cd ..
fi

# Format staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx|js|jsx|json|css|md)$' || true)
if [ -n "$STAGED_FILES" ]; then
  echo "üíÖ Formatting code with Prettier..."
  npx prettier --write $STAGED_FILES
  git add $STAGED_FILES
  echo -e "${GREEN}‚úì Code formatted${NC}"
fi

# Performance reminder
echo ""
echo -e "${YELLOW}üí° Reminder: Run these commands periodically:${NC}"
echo "   ‚Ä¢ npm run test:coverage - Check test coverage (target: 90%)"
echo "   ‚Ä¢ npm run lighthouse - Performance audit"
echo "   ‚Ä¢ npm run a11y:check - Accessibility audit"

echo ""
echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
echo ""