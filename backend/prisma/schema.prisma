generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id                    String                    @id @default(cuid())
  email                 String                    @unique
  password              String
  name                  String?
  role                  Role                      @default(RESEARCHER)
  isActive              Boolean                   @default(true)
  emailVerified         Boolean                   @default(false)
  twoFactorEnabled      Boolean                   @default(false)
  twoFactorSecret       String?
  lastLoginAt           DateTime?
  passwordChangedAt     DateTime                  @default(now())
  failedLoginAttempts   Int                       @default(0)
  lockedUntil           DateTime?
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  tenantId              String?                   @default("default")
  auditLogs             AuditLog[]
  invitedCollaborations Collaboration[]           @relation("CollaborationInviter")
  collaborations        Collaboration[]
  sentInvitations       CollaborationInvitation[] @relation("InvitationSender")
  emailVerifications    EmailVerification[]
  mediaFiles            MediaFile[]
  passwordResets        PasswordReset[]
  responses             Response[]
  sessions              Session[]
  supportTickets        SupportTicket[]
  surveys               Survey[]
  twoFactorBackups      TwoFactorBackup[]
  aiBudgetLimit         AIBudgetLimit?
  aiRateLimits          AIRateLimit[]
  aiUsage               AIUsage[]
  studyActivityLogs     StudyActivityLog[]        @relation("StudyActivityLogUser")
  studyCollaborations   StudyCollaborator[]       @relation("StudyCollaboratorUser")
  studyComments         StudyComment[]            @relation("StudyCommentUser")
  
  // Literature models (Phase 9)
  papers                Paper[]
  paperCollections      PaperCollection[]
  researchGaps          ResearchGap[]
  searchLogs            SearchLog[]

  @@index([email])
  @@index([tenantId])
  @@index([isActive])
}

model TwoFactorBackup {
  id        String   @id @default(cuid())
  userId    String
  code      String
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([used])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  refreshToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model EmailVerification {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Survey {
  id                      String             @id @default(cuid())
  title                   String
  description             String?
  status                  SurveyStatus       @default(DRAFT)
  createdBy               String
  tenantId                String?            @default("default")
  scheduledStart          DateTime?
  scheduledEnd            DateTime?
  maxResponses            Int?
  currentResponses        Int                @default(0)
  gridColumns             Int                @default(9)
  gridShape               String             @default("quasi-normal")
  gridConfig              Json?
  welcomeMessage          String?
  consentText             String?
  enablePreScreening      Boolean            @default(false)
  enablePostSurvey        Boolean            @default(true)
  enableVideoConferencing Boolean            @default(false)
  settings                Json?

  // Literature Pipeline Fields
  basedOnPapersIds        Json?              @default("[]") // Array of paper IDs stored as JSON
  researchGapId           String?
  extractedThemeIds       Json?              @default("[]") // Array of theme IDs stored as JSON
  studyContext            Json?              // Stores context like academic level, target statements, etc.
  literatureReviewId      String?

  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  analyses                Analysis[]
  collaborations          Collaboration[]
  gridConfiguration       GridConfiguration?
  mediaFiles              MediaFile[]
  questions               Question[]
  responses               Response[]
  statements              Statement[]
  stimuli                 Stimulus[]
  researchPipeline        ResearchPipeline?
  analysisResults         AnalysisResult[]
  researchGap             ResearchGap?       @relation(fields: [researchGapId], references: [id])
  creator                 User               @relation(fields: [createdBy], references: [id])

  @@index([createdBy])
  @@index([tenantId])
  @@index([status])
}

model Statement {
  id       String  @id @default(cuid())
  surveyId String
  text     String
  order    Int

  // Provenance tracking
  sourcePaperId   String?       // Which paper this statement originated from
  sourceThemeId   String?       // Which theme this statement was derived from
  perspective     String?       // Perspective: supportive, critical, neutral, balanced
  generationMethod String?      // How it was generated: theme-based, ai-augmented, manual
  confidence      Float?        // Confidence score 0-1
  provenance      Json?         // Full provenance data including citation chain

  sorts                 QSort[]
  survey                Survey                @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  statementProvenance   StatementProvenance?

  @@index([surveyId])
}

model Response {
  id            String               @id @default(cuid())
  surveyId      String
  participantId String?
  sessionCode   String               @unique
  completedAt   DateTime?
  timeSpent     Int?
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime             @default(now())
  demographics  Json?
  answers       Answer[]
  commentaries  Commentary[]
  progress      ParticipantProgress?
  preSort       PreSort?
  qSorts        QSort[]
  participant   User?                @relation(fields: [participantId], references: [id])
  survey        Survey               @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@index([surveyId])
  @@index([participantId])
  @@index([sessionCode])
}

model QSort {
  id          String    @id @default(cuid())
  responseId  String
  statementId String
  position    Int
  statement   Statement @relation(fields: [statementId], references: [id])
  response    Response  @relation(fields: [responseId], references: [id], onDelete: Cascade)

  @@unique([responseId, statementId])
  @@index([responseId])
}

model Question {
  id          String       @id @default(cuid())
  surveyId    String
  type        QuestionType
  text        String
  description String?
  required    Boolean      @default(true)
  order       Int
  validation  Json?
  options     Json?
  logic       Json?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  answers     Answer[]
  survey      Survey       @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@index([surveyId])
  @@index([type])
}

model Answer {
  id         String   @id @default(cuid())
  questionId String
  responseId String
  value      Json
  createdAt  DateTime @default(now())
  response   Response @relation(fields: [responseId], references: [id], onDelete: Cascade)
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([questionId, responseId])
  @@index([responseId])
}

model MediaFile {
  id              String   @id @default(cuid())
  filename        String
  originalName    String
  mimeType        String
  size            Int
  path            String
  url             String
  uploadedBy      String
  surveyId        String?
  isPublic        Boolean  @default(false)
  virusScanStatus String   @default("pending")
  createdAt       DateTime @default(now())
  survey          Survey?  @relation(fields: [surveyId], references: [id])
  uploader        User     @relation(fields: [uploadedBy], references: [id])

  @@index([uploadedBy])
  @@index([surveyId])
  @@index([virusScanStatus])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  resource   String?
  resourceId String?
  details    Json?
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([timestamp])
}

model SupportTicket {
  id          String           @id @default(cuid())
  userId      String
  category    String
  priority    String           @default("medium")
  subject     String
  description String
  status      String           @default("open")
  assignedTo  String?
  context     Json?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  messages    SupportMessage[]
  user        User             @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([priority])
}

model SupportMessage {
  id         String        @id @default(cuid())
  ticketId   String
  senderId   String?
  message    String
  isInternal Boolean       @default(false)
  createdAt  DateTime      @default(now())
  ticket     SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
}

model Collaboration {
  id          String            @id @default(cuid())
  studyId     String
  userId      String
  role        CollaborationRole
  permissions Json
  invitedBy   String
  acceptedAt  DateTime?
  createdAt   DateTime          @default(now())
  inviter     User              @relation("CollaborationInviter", fields: [invitedBy], references: [id])
  user        User              @relation(fields: [userId], references: [id])
  study       Survey            @relation(fields: [studyId], references: [id], onDelete: Cascade)

  @@unique([studyId, userId])
  @@index([studyId])
  @@index([userId])
}

model CollaborationInvitation {
  id         String            @id @default(cuid())
  studyId    String
  email      String
  role       CollaborationRole
  token      String            @unique
  expiresAt  DateTime
  acceptedAt DateTime?
  invitedBy  String
  createdAt  DateTime          @default(now())
  inviter    User              @relation("InvitationSender", fields: [invitedBy], references: [id])

  @@index([studyId])
  @@index([email])
  @@index([token])
}

model RateLimit {
  id          String   @id @default(cuid())
  identifier  String
  endpoint    String
  count       Int
  windowStart DateTime
  createdAt   DateTime @default(now())

  @@unique([identifier, endpoint, windowStart])
  @@index([identifier])
  @@index([endpoint])
}

model SystemHealth {
  id        String   @id @default(cuid())
  service   String
  status    String
  metrics   Json
  timestamp DateTime @default(now())

  @@index([service])
  @@index([timestamp])
}

model ParticipantProgress {
  id             String   @id @default(cuid())
  responseId     String   @unique
  currentStep    String   @default("welcome")
  completedSteps Json     @default("[]")
  stepData       Json?
  lastActiveAt   DateTime @default(now())
  response       Response @relation(fields: [responseId], references: [id], onDelete: Cascade)

  @@index([responseId])
}

model PreSort {
  id          String   @id @default(cuid())
  responseId  String   @unique
  disagree    Json
  neutral     Json
  agree       Json
  completedAt DateTime @default(now())
  response    Response @relation(fields: [responseId], references: [id], onDelete: Cascade)

  @@index([responseId])
}

model Commentary {
  id          String   @id @default(cuid())
  responseId  String
  statementId String
  position    Int
  comment     String
  wordCount   Int
  createdAt   DateTime @default(now())
  response    Response @relation(fields: [responseId], references: [id], onDelete: Cascade)

  @@index([responseId])
  @@index([statementId])
}

model Analysis {
  id          String         @id @default(cuid())
  surveyId    String
  userId      String?
  config      Json
  results     Json
  status      AnalysisStatus @default(PENDING)
  startedAt   DateTime?
  completedAt DateTime?
  error       String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  survey      Survey         @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@index([surveyId])
  @@index([userId])
  @@index([status])
}

model GridConfiguration {
  id           String   @id @default(cuid())
  surveyId     String   @unique
  rangeMin     Int      @default(-3)
  rangeMax     Int      @default(3)
  columns      Json
  symmetry     Boolean  @default(true)
  totalCells   Int
  distribution String   @default("bell")
  instructions String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  survey       Survey   @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@index([surveyId])
}

model Stimulus {
  id              String       @id @default(cuid())
  surveyId        String
  type            StimulusType
  content         String
  thumbnail       String?
  metadata        Json?
  position        Int?
  category        String?
  tags            Json?
  uploadStatus    String       @default("pending")
  uploadedBy      String?
  fileSize        Int?
  mimeType        String?
  virusScanStatus String       @default("pending")
  virusScanDate   DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  survey          Survey       @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@index([surveyId])
  @@index([type])
  @@index([uploadStatus])
  @@index([virusScanStatus])
}

model AIUsage {
  id               String   @id @default(cuid())
  userId           String   @map("user_id")
  endpoint         String
  model            String
  promptTokens     Int      @default(0) @map("prompt_tokens")
  completionTokens Int      @default(0) @map("completion_tokens")
  totalTokens      Int      @default(0) @map("total_tokens")
  cost             Float    @default(0)
  responseTimeMs   Int?     @map("response_time_ms")
  status           String   @default("success")
  errorMessage     String?  @map("error_message")
  metadata         String?
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([model])
  @@index([status])
  @@map("ai_usage")
}

model AIBudgetLimit {
  id              String   @id @default(cuid())
  userId          String   @unique @map("user_id")
  dailyLimitUsd   Float    @default(10.00) @map("daily_limit_usd")
  monthlyLimitUsd Float    @default(300.00) @map("monthly_limit_usd")
  alertThreshold  Float    @default(0.80) @map("alert_threshold")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("ai_budget_limits")
}

model AICache {
  id             String   @id @default(cuid())
  cacheKey       String   @unique @map("cache_key")
  promptHash     String   @map("prompt_hash")
  model          String
  response       String
  tokensSaved    Int      @default(0) @map("tokens_saved")
  costSaved      Float    @default(0) @map("cost_saved")
  hitCount       Int      @default(0) @map("hit_count")
  expiresAt      DateTime @map("expires_at")
  createdAt      DateTime @default(now()) @map("created_at")
  lastAccessedAt DateTime @default(now()) @map("last_accessed_at")

  @@index([cacheKey])
  @@index([expiresAt])
  @@index([promptHash])
  @@map("ai_cache")
}

model AIRateLimit {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  windowStart  DateTime @map("window_start")
  windowEnd    DateTime @map("window_end")
  requestCount Int      @default(0) @map("request_count")
  maxRequests  Int      @default(10) @map("max_requests")
  createdAt    DateTime @default(now()) @map("created_at")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([windowStart, windowEnd])
  @@map("ai_rate_limits")
}

model StudyCollaborator {
  id           String    @id @default(cuid())
  studyId      String    @map("study_id")
  userId       String    @map("user_id")
  role         String    @default("viewer")
  permissions  String
  invitedBy    String    @map("invited_by")
  invitedAt    DateTime  @default(now()) @map("invited_at")
  acceptedAt   DateTime? @map("accepted_at")
  lastActiveAt DateTime? @map("last_active_at")
  user         User      @relation("StudyCollaboratorUser", fields: [userId], references: [id])

  @@unique([studyId, userId])
  @@index([studyId])
  @@index([userId])
  @@map("study_collaborators")
}

model StudyComment {
  id         String         @id @default(cuid())
  studyId    String         @map("study_id")
  userId     String         @map("user_id")
  content    String
  sectionId  String?        @map("section_id")
  parentId   String?        @map("parent_id")
  edited     Boolean        @default(false)
  resolved   Boolean        @default(false)
  resolvedBy String?        @map("resolved_by")
  resolvedAt DateTime?      @map("resolved_at")
  timestamp  DateTime       @default(now())
  parent     StudyComment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies    StudyComment[] @relation("CommentReplies")
  user       User           @relation("StudyCommentUser", fields: [userId], references: [id])

  @@index([studyId])
  @@index([userId])
  @@index([parentId])
  @@map("study_comments")
}

model StudyActivityLog {
  id        String   @id @default(cuid())
  studyId   String   @map("study_id")
  userId    String   @map("user_id")
  action    String
  details   String?
  metadata  String?
  timestamp DateTime @default(now())
  user      User     @relation("StudyActivityLogUser", fields: [userId], references: [id])

  @@index([studyId])
  @@index([userId])
  @@index([action])
  @@index([timestamp])
  @@map("study_activity_logs")
}

model Participant {
  id            String         @id @default(cuid())
  studyId       String         @map("study_id")
  name          String?
  email         String
  phone         String?
  status        String         @default("invited")
  tags          String?
  notes         String?
  customFields  String?        @map("custom_fields")
  invitedAt     DateTime       @default(now()) @map("invited_at")
  respondedAt   DateTime?      @map("responded_at")
  completedAt   DateTime?      @map("completed_at")
  appointments  Appointment[]
  compensations Compensation[]

  @@unique([studyId, email])
  @@index([studyId])
  @@index([email])
  @@index([status])
  @@map("participants")
}

model Appointment {
  id             String        @id @default(cuid())
  studyId        String        @map("study_id")
  participantId  String        @map("participant_id")
  scheduledStart DateTime      @map("scheduled_start")
  scheduledEnd   DateTime      @map("scheduled_end")
  status         String        @default("scheduled")
  type           String        @default("online")
  location       String?
  meetingUrl     String?       @map("meeting_url")
  notes          String?
  remindersSent  Int           @default(0) @map("reminders_sent")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  participant    Participant   @relation(fields: [participantId], references: [id])
  compensation   Compensation?
  reminders      Reminder[]

  @@index([studyId])
  @@index([participantId])
  @@index([scheduledStart])
  @@index([status])
  @@map("appointments")
}

model Reminder {
  id            String      @id @default(cuid())
  appointmentId String      @map("appointment_id")
  type          String      @default("email")
  scheduledFor  DateTime    @map("scheduled_for")
  sentAt        DateTime?   @map("sent_at")
  status        String      @default("pending")
  attempts      Int         @default(0)
  lastAttemptAt DateTime?   @map("last_attempt_at")
  errorMessage  String?     @map("error_message")
  appointment   Appointment @relation(fields: [appointmentId], references: [id])

  @@index([appointmentId])
  @@index([scheduledFor])
  @@index([status])
  @@map("reminders")
}

model Compensation {
  id            String      @id @default(cuid())
  appointmentId String      @unique @map("appointment_id")
  participantId String      @map("participant_id")
  amount        Float
  currency      String      @default("USD")
  method        String
  status        String      @default("pending")
  approvedBy    String?     @map("approved_by")
  approvedAt    DateTime?   @map("approved_at")
  paidAt        DateTime?   @map("paid_at")
  reference     String?
  notes         String?
  createdAt     DateTime    @default(now()) @map("created_at")
  participant   Participant @relation(fields: [participantId], references: [id])
  appointment   Appointment @relation(fields: [appointmentId], references: [id])

  @@index([participantId])
  @@index([status])
  @@map("compensations")
}

model StudyAvailability {
  id                     String   @id @default(cuid())
  studyId                String   @map("study_id")
  dayOfWeek              Int      @map("day_of_week")
  startTime              String   @map("start_time")
  endTime                String   @map("end_time")
  timezone               String   @default("UTC")
  slotDuration           Int      @default(60) @map("slot_duration")
  bufferTime             Int      @default(15) @map("buffer_time")
  maxParticipantsPerSlot Int      @default(1) @map("max_participants_per_slot")
  isActive               Boolean  @default(true) @map("is_active")
  createdAt              DateTime @default(now()) @map("created_at")

  @@index([studyId])
  @@index([dayOfWeek])
  @@map("study_availability")
}

enum StimulusType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
}

enum AnalysisStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum Role {
  ADMIN
  RESEARCHER
  PARTICIPANT
}

enum SurveyStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  ENDED
  ARCHIVED
}

enum QuestionType {
  MULTIPLE_CHOICE_SINGLE
  MULTIPLE_CHOICE_MULTI
  DROPDOWN
  RATING_SCALE
  LIKERT_SCALE
  SEMANTIC_DIFFERENTIAL
  TEXT_ENTRY
  NUMERIC_ENTRY
  DATE_TIME
  SLIDER
  RANK_ORDER
  MATRIX_GRID
  FILE_UPLOAD
  CONSTANT_SUM
  NET_PROMOTER_SCORE
  IMAGE_CHOICE
  VIDEO_RESPONSE
}

enum CollaborationRole {
  OWNER
  COLLABORATOR
  VIEWER
}

// Literature Review Models (Phase 9)
model Paper {
  id            String   @id @default(cuid())
  title         String
  authors       Json     // JSON array of author names
  year          Int
  abstract      String?
  journal       String?  // Journal name
  volume        String?  // Volume number
  issue         String?  // Issue/Number
  pages         String?  // Page range (e.g., "123-145")
  doi           String?  
  url           String?
  venue         String?
  citationCount Int?
  keywords      Json?    // JSON array of keywords
  fieldsOfStudy Json?    // JSON array of fields
  references    Json?    // JSON array of reference IDs
  citations     Json?    // JSON array of citation IDs
  source        String   // LiteratureSource enum as string
  
  // User library fields
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tags          Json?    // User-defined tags
  notes         String?
  collectionId  String?
  collection    PaperCollection? @relation(fields: [collectionId], references: [id])
  
  // PDF support
  pdfPath       String?
  hasFullText   Boolean  @default(false)
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  themes        PaperTheme[]
  gaps          ResearchGap[]
  statementProvenances StatementProvenance[]
  
  @@index([userId])
  @@index([doi])
  @@index([collectionId])
  @@map("papers")
}

model PaperCollection {
  id          String   @id @default(cuid())
  name        String
  description String?
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  papers      Paper[]
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@map("paper_collections")
}

model PaperTheme {
  id              String   @id @default(cuid())
  name            String
  keywords        Json     // JSON array
  relevanceScore  Float
  emergenceYear   Int?
  trendDirection  String?  // 'rising' | 'stable' | 'declining'
  papers          Paper[]
  statementProvenances StatementProvenance[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("paper_themes")
}

model ResearchGap {
  id                   String   @id @default(cuid())
  title                String
  description          String
  field                String
  opportunityScore     Float
  suggestedMethods     Json     // JSON array
  potentialImpact      String
  fundingOpportunities Json?    // JSON array
  collaborators        Json?    // JSON array
  relatedPapers        Paper[]

  // Phase 9 Day 10 additions
  status               String?  @default("identified") // identified, partially_addressed, fully_addressed
  addressingStudies    Survey[] // Studies that address this gap
  completionPercentage Float?   @default(0.0)
  findings             Json?    // Key findings that address the gap
  lastUpdated          DateTime?

  userId               String
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([userId])
  @@map("research_gaps")
}

model SearchLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  query     String
  filters   Json     // Store search filters as JSON
  timestamp DateTime @default(now())

  @@index([userId])
  @@index([timestamp])
  @@map("search_logs")
}

model ResearchPipeline {
  id                     String   @id @default(cuid())
  surveyId               String   @unique
  survey                 Survey   @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  // Literature Phase
  literatureSearchIds    Json?               @default("[]") // IDs of literature searches performed
  selectedPaperIds       Json?               @default("[]") // Papers selected for the study
  extractedThemes        Json?               // Themes extracted from papers
  researchGaps           Json?               // Identified research gaps

  // Study Design Phase
  generatedStatements    Json?               // Statements generated from themes
  statementProvenance    Json?               // Provenance for each statement
  methodSuggestions      Json?               // Suggested methods from similar studies

  // Analysis Phase
  analysisIds            Json?               @default("[]") // IDs of analyses performed
  factorInterpretations  Json?               // AI-assisted factor interpretations

  // Report Phase
  reportIds              Json?               @default("[]") // Generated reports
  narratives             Json?               // Generated narratives

  // Archive Phase
  doiIdentifier          String?             // DOI for archived study
  archiveMetadata        Json?               // Metadata for archive systems

  // Tracking
  currentPhase           String              @default("literature")
  completedPhases        Json?               @default("[]") // Completed phases as JSON array
  pipelineMetadata       Json?               // Additional metadata

  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt

  @@index([surveyId])
  @@map("research_pipelines")
}

// Phase 9 Day 10: Knowledge Graph Models for Literature-Analysis Integration

model KnowledgeNode {
  id               String   @id @default(cuid())
  type             String   // PAPER, FINDING, CONCEPT, THEORY, GAP, STATEMENT, BRIDGE_CONCEPT
  label            String
  description      String?
  sourceStudyId    String?
  sourcePaperId    String?
  confidence       Float?   @default(0.5)
  metadata         Json?

  // Phase 9 Day 14-15: Enhanced Graph Features
  isBridgeConcept  Boolean  @default(false) // Connects disparate research areas
  controversyScore Float?   // 0-1, higher = more controversial
  influenceScore   Float?   // Centrality/importance in the graph
  citationCount    Int      @default(0)     // Number of citations
  trendingScore    Float?   // Trending/emerging topic score
  keywords         Json?    @default("[]")  // Array of extracted keywords

  // ML Predictions
  predictedImpact  Float?   // Predicted research impact score
  emergingTopic    Boolean  @default(false) // Is this an emerging topic?
  fundingPotential Float?   // Predicted funding probability 0-1

  // Relationships
  outgoingEdges    KnowledgeEdge[] @relation("FromNode")
  incomingEdges    KnowledgeEdge[] @relation("ToNode")

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([type])
  @@index([sourceStudyId])
  @@index([sourcePaperId])
  @@index([isBridgeConcept])
  @@index([emergingTopic])
  @@map("knowledge_nodes")
}

model KnowledgeEdge {
  id               String   @id @default(cuid())
  fromNodeId       String
  fromNode         KnowledgeNode @relation("FromNode", fields: [fromNodeId], references: [id], onDelete: Cascade)
  toNodeId         String
  toNode           KnowledgeNode @relation("ToNode", fields: [toNodeId], references: [id], onDelete: Cascade)

  type             String   // SUPPORTS, CONTRADICTS, EXTENDS, RELATED, DERIVED_FROM, CITES, INFLUENCES
  strength         Float    @default(0.5) // 0-1 strength of relationship
  metadata         Json?

  // Phase 9 Day 14-15: Enhanced Edge Features
  influenceFlow    Float?   // Directional influence strength
  controversyType  String?  // Type of controversy (METHODOLOGY, FINDINGS, THEORY)
  isPredicted      Boolean  @default(false) // Is this a predicted "missing link"?
  predictionScore  Float?   // Confidence in prediction 0-1
  temporalWeight   Float?   // Time-decay weight for citations

  createdAt        DateTime @default(now())

  @@unique([fromNodeId, toNodeId, type])
  @@index([fromNodeId])
  @@index([toNodeId])
  @@index([type])
  @@index([isPredicted])
  @@map("knowledge_edges")
}

model KnowledgeBase {
  id               String   @id @default(cuid())
  type             String   // EMPIRICAL_FINDING, THEORETICAL_CONCEPT, METHOD, GAP
  category         String?
  description      String
  evidence         Json?    // Supporting evidence
  confidence       Float    @default(0.5)
  sourceStudyId    String?
  citations        Json?    // Array of citations
  tags             Json?    // Array of tags
  isVerified       Boolean  @default(false)
  needsReplication Boolean  @default(true)
  supportingStudies Json?   @default("[]") // Array of study IDs

  // Cross-references
  crossReferences  KnowledgeCrossReference[] @relation("FromKnowledge")
  referencedBy     KnowledgeCrossReference[] @relation("ToKnowledge")

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  lastVerified     DateTime?

  @@index([type])
  @@index([category])
  @@index([sourceStudyId])
  @@index([isVerified])
  @@map("knowledge_base")
}

model KnowledgeCrossReference {
  id               String   @id @default(cuid())
  fromId           String
  fromEntry        KnowledgeBase @relation("FromKnowledge", fields: [fromId], references: [id], onDelete: Cascade)
  toId             String
  toEntry          KnowledgeBase @relation("ToKnowledge", fields: [toId], references: [id], onDelete: Cascade)

  type             String   // RELATED, PREREQUISITE, CONTRADICTION, EXTENSION
  strength         Float    @default(0.5)

  createdAt        DateTime @default(now())

  @@unique([fromId, toId])
  @@map("knowledge_cross_references")
}

model AnalysisResult {
  id               String   @id @default(cuid())
  surveyId         String
  survey           Survey   @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  factors          Json?    // Factor analysis results
  consensus        Json?    // Consensus statements
  distinguishing   Json?    // Distinguishing statements
  totalVariance    Float?   // Total variance explained
  participantCount Int?

  // Literature comparison results
  comparisonId     String?
  comparison       Json?    // Literature comparison data

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([surveyId])
  @@map("analysis_results")
}

model StatementProvenance {
  id               String   @id @default(cuid())
  statementId      String   @unique
  statement        Statement @relation(fields: [statementId], references: [id], onDelete: Cascade)

  sourcePaperId    String?
  sourcePaper      Paper?   @relation(fields: [sourcePaperId], references: [id])
  sourceThemeId    String?
  sourceTheme      PaperTheme? @relation(fields: [sourceThemeId], references: [id])

  generationMethod String?  // LITERATURE_EXTRACTION, AI_GENERATION, MANUAL, etc.
  confidence       Float?   @default(0.5)
  metadata         Json?

  createdAt        DateTime @default(now())

  @@index([sourcePaperId])
  @@index([sourceThemeId])
  @@map("statement_provenance")
}

// ============================================
// PHASE 9 DAY 18: Multi-Modal Transcription
// ============================================

/// Video/Podcast transcription storage with timestamps
model VideoTranscript {
  id              String   @id @default(uuid())
  sourceId        String   // YouTube video ID or podcast URL
  sourceType      String   // 'youtube' | 'podcast' | 'tiktok' | 'instagram'
  sourceUrl       String
  title           String
  author          String?  // Channel name or podcast host
  duration        Int      // Duration in seconds
  transcript      String   // Full plain text transcript
  timestampedText Json     // Array of {timestamp: number, text: string, speaker?: string}
  language        String   @default("en")
  confidence      Float?   // Whisper transcription confidence (0-1)
  processedAt     DateTime @default(now())

  // Cost tracking
  transcriptionCost Float? // Whisper API cost for this transcription
  analysisCost      Float? // GPT-4 theme extraction cost

  // Metadata
  metadata        Json?    // Platform-specific metadata (views, likes, etc.)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  themes          TranscriptTheme[]
  citations       MultimediaCitation[]
  socialMedia     SocialMediaContent?

  @@unique([sourceId, sourceType])
  @@index([sourceType])
  @@index([processedAt])
  @@index([sourceUrl])
  @@map("video_transcripts")
}

/// Themes extracted from video/podcast transcripts
model TranscriptTheme {
  id              String   @id @default(uuid())
  transcriptId    String
  transcript      VideoTranscript @relation(fields: [transcriptId], references: [id], onDelete: Cascade)

  theme           String   // Theme label (e.g., "Climate Change Adaptation")
  relevanceScore  Float    // 0-1, how relevant this theme is to the content
  timestamps      Json     // Array of {start: number, end: number} where theme appears
  keywords        Json     // Array of extracted keywords for this theme

  // GPT-4 analysis
  summary         String?  // AI-generated summary of this theme in the video
  quotes          Json?    // Array of {timestamp, quote} - key quotes for this theme

  createdAt       DateTime @default(now())

  @@index([transcriptId])
  @@index([theme])
  @@map("transcript_themes")
}

/// Citations/references found in video/podcast transcripts
model MultimediaCitation {
  id              String   @id @default(uuid())
  transcriptId    String
  transcript      VideoTranscript @relation(fields: [transcriptId], references: [id], onDelete: Cascade)

  citedWork       String   // Paper title, author, or claim being cited
  citationType    String   @default("mention") // 'mention' | 'citation' | 'reference'
  timestamp       Int      // Second in video/podcast where citation occurs
  context         String   // Surrounding text for context (~200 chars)
  confidence      Float    // 0-1, how confident we are this is a citation

  // Parsed citation details (if structured)
  parsedCitation  Json?    // {author?, title?, year?, doi?}

  createdAt       DateTime @default(now())

  @@index([transcriptId])
  @@index([citedWork])
  @@map("multimedia_citations")
}

// ============================================
// PHASE 9 DAY 19: Social Media Integration
// ============================================

/// Social media content (TikTok, Instagram)
model SocialMediaContent {
  id              String   @id @default(uuid())
  platform        String   // 'tiktok' | 'instagram' | 'youtube_short'
  platformId      String   // Platform-specific video ID
  url             String   @unique
  title           String?
  description     String?
  author          String   // Username/handle
  authorId        String?  // Platform-specific user ID
  publishedAt     DateTime

  // Engagement metrics
  views           Int?
  likes           Int?
  shares          Int?
  comments        Int?

  // Content analysis
  transcriptId    String?  @unique
  transcript      VideoTranscript? @relation(fields: [transcriptId], references: [id])
  hashtags        Json?    // Array of extracted hashtags
  trends          Json?    // Platform-specific trend data

  // Research relevance
  relevanceScore  Float?   // 0-1, how relevant to research query
  researchThemes  Json?    // Array of themes identified in this content

  // Upload metadata (for manual uploads like Instagram)
  uploadMethod    String   @default("api") // 'api' | 'manual_upload'

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([platform, platformId])
  @@index([platform])
  @@index([publishedAt])
  @@index([relevanceScore])
  @@index([author])
  @@map("social_media_content")
}

// ============================================
// PHASE 9 DAY 20: Unified Theme Extraction
// ============================================

/// Unified theme model that consolidates paper themes and multimedia themes
/// Provides single source of truth with full provenance tracking
model UnifiedTheme {
  id              String   @id @default(uuid())
  label           String   // Theme name (e.g., "Climate Change Adaptation")
  description     String?  // AI-generated description
  keywords        Json     // string[] - Extracted keywords
  weight          Float    // 0-1 - Importance/prevalence of this theme
  controversial   Boolean  @default(false)

  // Relations
  sources         ThemeSource[]
  provenance      ThemeProvenance?

  // Study association
  studyId         String?
  collectionId    String?  // Link to paper collection if applicable

  // Metadata
  extractedAt     DateTime @default(now())
  extractionModel String   // "gpt-4-turbo-preview" or other model
  confidence      Float    // 0-1 - Overall confidence in theme extraction

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([studyId])
  @@index([collectionId])
  @@index([weight])
  @@map("unified_themes")
}

/// Individual source that contributed to a unified theme
/// Tracks statistical influence and provides audit trail
model ThemeSource {
  id              String   @id @default(uuid())
  themeId         String
  theme           UnifiedTheme @relation(fields: [themeId], references: [id], onDelete: Cascade)

  // Source identification
  sourceType      String   // "paper" | "youtube" | "podcast" | "tiktok" | "instagram"
  sourceId        String   // ID from respective table (Paper.id, VideoTranscript.id, etc.)
  sourceUrl       String?  // DOI for papers, video URL for multimedia
  sourceTitle     String   // Paper title or video title
  sourceAuthor    String?  // Author names or channel name

  // Statistical influence (how much this source contributed to theme)
  influence       Float    // 0-1 - This source's contribution to theme
  keywordMatches  Int      // Number of theme keywords found in source
  excerpts        Json     // string[] - Relevant quotes/text from source

  // Multimedia-specific (null for papers)
  timestamps      Json?    // {start: number, end: number, text: string}[] - Relevant video segments

  // Paper-specific (null for multimedia)
  doi             String?
  authors         Json?    // string[] - Paper authors
  year            Int?     // Publication year

  createdAt       DateTime @default(now())

  @@index([themeId])
  @@index([sourceType])
  @@index([sourceId])
  @@map("theme_sources")
}

/// Statistical provenance tracking for themes
/// Shows which source types contributed most to each theme
model ThemeProvenance {
  id              String   @id @default(uuid())
  themeId         String   @unique
  theme           UnifiedTheme @relation(fields: [themeId], references: [id], onDelete: Cascade)

  // Statistical breakdown (percentages, sum = 1.0)
  paperInfluence      Float  @default(0.0)  // e.g., 0.65 = 65% from papers
  videoInfluence      Float  @default(0.0)  // e.g., 0.25 = 25% from videos
  podcastInfluence    Float  @default(0.0)  // e.g., 0.10 = 10% from podcasts
  socialInfluence     Float  @default(0.0)  // e.g., 0.00 = 0% from social media

  // Source counts
  paperCount          Int    @default(0)
  videoCount          Int    @default(0)
  podcastCount        Int    @default(0)
  socialCount         Int    @default(0)

  // Quality metrics
  averageConfidence   Float  // Average confidence across all sources
  citationChain       Json   // string[] - For reproducibility

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("theme_provenance")
}
